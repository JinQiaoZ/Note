<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用缓存 | 笔记</title>
    <meta name="description" content="世界上最大的谎言就是你不行">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/wliduo/Index@master/static/favicon.ico">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/wliduo/Index@master/static/count.js"></script>
    
    <link rel="preload" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/css/0.styles.506a285f.css" as="style"><link rel="preload" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/app.4fdd9329.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/2.def9963f.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/80.faf6cde6.js" as="script"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/10.09ea48d7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/11.eaca0874.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/12.f46c7230.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/13.cad14991.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/14.fa6a4f2b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/15.21cffcae.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/16.0c2d4ae4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/17.d35379aa.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/18.6d900e7a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/19.c5934168.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/20.fd4d0b9b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/21.36faaeb4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/22.b7358780.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/23.87f68419.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/24.50b28a30.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/25.b584981e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/26.d1121e85.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/27.37897049.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/28.8b5b22f3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/29.730aa594.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/3.99bff156.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/30.0fcd32f7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/31.ffd2cddb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/32.a1233b78.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/33.387ce138.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/34.e009524b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/35.2fe1a669.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/36.20c906e4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/37.998e50d4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/38.61b23dc8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/39.562e8b96.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/4.75686616.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/40.51fbcfa0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/41.84624b92.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/42.d8db06a9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/43.21375d13.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/44.035fc461.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/45.45f2a816.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/46.4ac3ccac.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/47.3ee039ee.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/48.347cdb64.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/49.f401ef97.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/5.f79ca32d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/50.626cfa4d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/51.0e5831b8.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/52.86adc513.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/53.acc8442c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/54.32384dc5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/55.18a4882e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/56.40e8d8da.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/57.c85ecd6f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/58.76e2cb43.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/59.53e517a1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/6.032a6df7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/60.de6f0625.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/61.400ef9b4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/62.26bba11f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/63.1c62f49d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/64.efdc2dfb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/65.b7cc5bf3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/66.dafb5b1d.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/67.e6c3e208.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/68.b6849f77.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/69.5626f255.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/7.18d07b8c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/70.ae762e65.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/71.804fcd0a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/72.d94dce18.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/73.bed26e85.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/74.9cd249f0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/75.f4d541f5.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/76.4ec4071f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/77.a9c08c56.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/78.f1403e28.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/79.0562631f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/8.fdbc780e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/81.f00e8801.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/82.8a0b5bae.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/83.bcb68759.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/84.142098a3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/85.e05c144c.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/86.d9a4a3ce.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/87.ab28cb9a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/88.79f38bbe.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/89.03da9d44.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/9.1382cfa9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/90.2440f23b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/91.8ea97238.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/92.4705b20b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/93.fe847ac3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/94.e9c67f42.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/95.37595f54.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/96.70bda630.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/97.fc6a9662.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/98.7e33b303.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/99.1b115f6d.js">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/css/0.styles.506a285f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习记录" class="dropdown-title"><span class="title">学习记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/database/" class="nav-link">Database</a></li><li class="dropdown-item"><!----> <a href="/cache/" class="nav-link">Cache</a></li><li class="dropdown-item"><!----> <a href="/elasticsearch/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/command/" class="nav-link">工具命令</a></li><li class="dropdown-item"><!----> <a href="/front/" class="nav-link">前端记录</a></li><li class="dropdown-item"><!----> <a href="/note/" class="nav-link">零散记录</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构记录" class="dropdown-title"><span class="title">架构记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/distributed/" class="nav-link">分布式</a></li><li class="dropdown-item"><!----> <a href="/seckill/" class="nav-link">秒杀架构</a></li><li class="dropdown-item"><!----> <a href="/dubbo/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/springcloud/" class="nav-link">SpringCloud</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/p/" class="nav-link">项目列表</a></li><li class="dropdown-item"><!----> <a href="/shirojwt/" class="nav-link">鉴权-ShiroJwt</a></li><li class="dropdown-item"><!----> <a href="/seckill-evolution/" class="nav-link router-link-active">秒杀-SeckillEvolution</a></li><li class="dropdown-item"><!----> <a href="/netty/" class="nav-link">聊天-NettyStudy</a></li><li class="dropdown-item"><!----> <a href="/viewgenerator/" class="nav-link">代码生成器-ViewGenerator</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他补充" class="dropdown-title"><span class="title">其他补充</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">其他记录</a></li><li class="dropdown-item"><!----> <a href="/gossip/" class="nav-link">编程闲话</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="联系" class="dropdown-title"><span class="title">联系</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  首页
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://map.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://res.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  音乐
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://msg.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  留言
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://cv.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简历
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://github.com/dolyw" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习记录" class="dropdown-title"><span class="title">学习记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/database/" class="nav-link">Database</a></li><li class="dropdown-item"><!----> <a href="/cache/" class="nav-link">Cache</a></li><li class="dropdown-item"><!----> <a href="/elasticsearch/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/command/" class="nav-link">工具命令</a></li><li class="dropdown-item"><!----> <a href="/front/" class="nav-link">前端记录</a></li><li class="dropdown-item"><!----> <a href="/note/" class="nav-link">零散记录</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构记录" class="dropdown-title"><span class="title">架构记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/distributed/" class="nav-link">分布式</a></li><li class="dropdown-item"><!----> <a href="/seckill/" class="nav-link">秒杀架构</a></li><li class="dropdown-item"><!----> <a href="/dubbo/" class="nav-link">Dubbo</a></li><li class="dropdown-item"><!----> <a href="/springcloud/" class="nav-link">SpringCloud</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/p/" class="nav-link">项目列表</a></li><li class="dropdown-item"><!----> <a href="/shirojwt/" class="nav-link">鉴权-ShiroJwt</a></li><li class="dropdown-item"><!----> <a href="/seckill-evolution/" class="nav-link router-link-active">秒杀-SeckillEvolution</a></li><li class="dropdown-item"><!----> <a href="/netty/" class="nav-link">聊天-NettyStudy</a></li><li class="dropdown-item"><!----> <a href="/viewgenerator/" class="nav-link">代码生成器-ViewGenerator</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他补充" class="dropdown-title"><span class="title">其他补充</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">其他记录</a></li><li class="dropdown-item"><!----> <a href="/gossip/" class="nav-link">编程闲话</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="联系" class="dropdown-title"><span class="title">联系</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  首页
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://map.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://res.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  音乐
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://msg.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  留言
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://cv.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简历
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://github.com/dolyw" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/seckill-evolution/" class="sidebar-link">SeckillEvolution</a></li><li><a href="/seckill-evolution/00-Preparation.html" class="sidebar-link">0. 整体流程</a></li><li><a href="/seckill-evolution/01-Tradition-Process.html" class="sidebar-link">1. 传统方式</a></li><li><a href="/seckill-evolution/02-Optimistic-Lock.html" class="sidebar-link">2. 使用乐观锁</a></li><li><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html" class="active sidebar-link">3. 使用缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html#_1-思路介绍" class="sidebar-link">1. 思路介绍</a></li><li class="sidebar-sub-header"><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html#_2-代码实现" class="sidebar-link">2. 代码实现</a></li><li class="sidebar-sub-header"><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html#_3-错误实现" class="sidebar-link">3. 错误实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html#_3-1-开始测试" class="sidebar-link">3.1. 开始测试</a></li><li class="sidebar-sub-header"><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html#_3-2-结果总结" class="sidebar-link">3.2. 结果总结</a></li><li class="sidebar-sub-header"><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html#_3-3-如何解决" class="sidebar-link">3.3. 如何解决</a></li></ul></li><li class="sidebar-sub-header"><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html#_4-正确实现" class="sidebar-link">4. 正确实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html#_4-1-开始测试" class="sidebar-link">4.1. 开始测试</a></li><li class="sidebar-sub-header"><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html#_4-2-结果总结" class="sidebar-link">4.2. 结果总结</a></li></ul></li></ul></li><li><a href="/seckill-evolution/04-Distributed-Limit.html" class="sidebar-link">4. 使用分布式限流</a></li><li><a href="/seckill-evolution/05-MQ-Async.html" class="sidebar-link">5. 使用队列异步下单</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用缓存"><a href="#使用缓存" class="header-anchor">#</a> 使用缓存</h1> <p><strong>地址</strong></p> <ul><li>Github：<a href="https://github.com/dolyw/SeckillEvolution" target="_blank" rel="noopener noreferrer">https://github.com/dolyw/SeckillEvolution<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Gitee(码云)：<a href="https://gitee.com/dolyw/SeckillEvolution" target="_blank" rel="noopener noreferrer">https://gitee.com/dolyw/SeckillEvolution<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p><a href="/seckill-evolution/" class="router-link-active"><strong>目录</strong></a></p> <ul><li><a href="/seckill-evolution/00-Preparation.html">0. 整体流程</a></li> <li><a href="/seckill-evolution/01-Tradition-Process.html">1. 传统方式</a></li> <li><a href="/seckill-evolution/02-Optimistic-Lock.html">2. 使用乐观锁</a></li> <li><strong>3. 使用缓存</strong></li> <li><a href="/seckill-evolution/04-Distributed-Limit.html">4. 使用分布式限流</a></li> <li><a href="/seckill-evolution/05-MQ-Async.html">5. 使用队列异步下单</a></li></ul> <h2 id="_1-思路介绍"><a href="#_1-思路介绍" class="header-anchor">#</a> 1. 思路介绍</h2> <p>这次我们引入<strong>缓存</strong>，这里可以先查看一篇文章: <a href="https://note.dolyw.com/cache/00-DataBaseConsistency.html" target="_blank" rel="noopener noreferrer">Redis与数据库一致性<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>一般秒杀都会提前预热缓存，我们添加一个<strong>缓存预热</strong>的方法，初始化库存后再<strong>缓存预热</strong>，这样不会出现<strong>Cache</strong>读取<strong>Miss</strong>的情况</p> <p>这里我采用的是<strong>先更新数据库再更新缓存</strong>，因为这里<strong>缓存数据计算简单</strong>，只需要进行加减一即可，所以我们直接进行更新缓存</p> <p>这次主要改造是<strong>检查库存和扣库存</strong>方法，<strong>检查库存</strong>直接去<strong>Redis</strong>获取，不再去查数据库，而在<strong>扣库存</strong>这里本身是使用的乐观锁操作，只有操作成功(扣库存成功)的才需要<strong>更新缓存数据</strong></p> <h2 id="_2-代码实现"><a href="#_2-代码实现" class="header-anchor">#</a> 2. 代码实现</h2> <p>引入<strong>Redis</strong></p> <ul><li><strong>pom.xml</strong></li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jedis.version</span><span class="token punctuation">&gt;</span></span>2.9.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jedis.version</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- Redis-Jedis --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${jedis.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li><strong>application.yml</strong></li></ul> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token comment"># Redis服务器地址</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token comment"># Redis服务器连接端口</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
    <span class="token comment"># Redis服务器连接密码（默认为空）</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span>
    <span class="token comment"># 连接超时时间（毫秒）</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">10000</span>
    <span class="token key atrule">pool</span><span class="token punctuation">:</span>
        <span class="token comment"># 连接池最大连接数（使用负值表示没有限制）</span>
        <span class="token key atrule">max-active</span><span class="token punctuation">:</span> <span class="token number">200</span>
        <span class="token comment"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span>
        <span class="token key atrule">max-wait</span><span class="token punctuation">:</span> <span class="token number">-1</span>
        <span class="token comment"># 连接池中的最大空闲连接</span>
        <span class="token key atrule">max-idle</span><span class="token punctuation">:</span> <span class="token number">8</span>
        <span class="token comment"># 连接池中的最小空闲连接</span>
        <span class="token key atrule">min-idle</span><span class="token punctuation">:</span> <span class="token number">0</span>
</code></pre></div><ul><li><strong>JedisConfig</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>config<span class="token punctuation">.</span>redis</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Jedis配置，项目启动注入JedisPool
 *
 * @author dolyw.com
 * @date 2018/9/5 10:35
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAutoConfiguration</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;redis&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisConfig</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * logger
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">JedisConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> timeout<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${redis.pool.max-active}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxActive<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${redis.pool.max-wait}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxWait<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${redis.pool.max-idle}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxIdle<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${redis.pool.min-idle}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> minIdle<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JedisPool</span> <span class="token function">redisPoolFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">JedisPoolConfig</span> jedisPoolConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span>maxIdle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMaxWaitMillis</span><span class="token punctuation">(</span>maxWait<span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span>maxActive<span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedisPoolConfig<span class="token punctuation">.</span><span class="token function">setMinIdle</span><span class="token punctuation">(</span>minIdle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 密码为空设置为null</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                password <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">JedisPool</span> jedisPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>jedisPoolConfig<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;初始化Redis连接池JedisPool成功!地址: &quot;</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> jedisPool<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;初始化Redis连接池JedisPool异常:&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// GETSET...</span>
<span class="token punctuation">}</span>

</code></pre></div><p>先定义三个全局常量</p> <ul><li><strong>Constant</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>constant</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 常量
 *
 * @author wliduo[i@dolyw.com]
 * @date 2018/9/3 16:03
 */</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Constant</span> <span class="token punctuation">{</span>

    <span class="token comment">// 其他常量...</span>

    <span class="token comment">/**
     * redis-key-前缀-count-库存
     */</span>
    <span class="token class-name">String</span> PREFIX_COUNT <span class="token operator">=</span> <span class="token string">&quot;stock:count:&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * redis-key-前缀-sale-已售
     */</span>
    <span class="token class-name">String</span> PREFIX_SALE <span class="token operator">=</span> <span class="token string">&quot;stock:sale:&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * redis-key-前缀-version-乐观锁版本
     */</span>
    <span class="token class-name">String</span> PREFIX_VERSION <span class="token operator">=</span> <span class="token string">&quot;stock:version:&quot;</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>在<strong>SeckillEvolutionController</strong>创建缓存预热方法，以及乐观锁加缓存下单的入口方法</p> <ul><li><strong>SeckillEvolutionController</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 缓存预热
 *
 * @param id 商品ID
 * @return com.example.common.ResponseBean
 * @throws
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/22 15:59
 */</span>
<span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/initCache/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseBean</span> <span class="token function">initCache</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StockDto</span> stockDto <span class="token operator">=</span> stockService<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 商品缓存预热</span>
    <span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_COUNT <span class="token operator">+</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_SALE <span class="token operator">+</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getSale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_VERSION <span class="token operator">+</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBean</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;缓存预热成功&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 使用乐观锁下订单，并且添加读缓存，性能提升
 *
 * @param id 商品ID
 * @return com.example.common.ResponseBean
 * @throws Exception
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/22 14:24
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/createOptimisticLockOrderWithRedis/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseBean</span> <span class="token function">createOptimisticLockOrderWithRedis</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 错误的，线程不安全</span>
    <span class="token class-name">Integer</span> orderCount <span class="token operator">=</span> seckillEvolutionService<span class="token punctuation">.</span><span class="token function">createOptimisticLockOrderWithRedisWrong</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 正确的，线程安全</span>
    <span class="token comment">// Integer orderCount = seckillEvolutionService.createOptimisticLockOrderWithRedisSafe(id);</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBean</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;购买成功&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在<strong>Service</strong>添加两个方法(缓存线程安全和不安全的两个方法)</p> <ul><li><strong>ISeckillEvolutionService</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 使用乐观锁创建订单(解决卖超问题)，加缓存读(线程不安全)，提升性能，
 *
 * @param id
 * @return java.lang.Integer
 * @throws Exception
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/22 14:21
 */</span>
<span class="token class-name">Integer</span> <span class="token function">createOptimisticLockOrderWithRedisWrong</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 使用乐观锁创建订单(解决卖超问题)，加缓存读(线程安全)，提升性能，
 *
 * @param id
 * @return java.lang.Integer
 * @throws Exception
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/22 14:21
 */</span>
<span class="token class-name">Integer</span> <span class="token function">createOptimisticLockOrderWithRedisSafe</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><strong>ISeckillEvolutionService</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 乐观锁加缓存方法(名称注入)，线程不安全
 */</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;seckillOptimisticLockRedisWrongService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">ISeckillService</span> <span class="token class-name">SeckillOptimisticLockRedisWrongServiceImpl</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 乐观锁加缓存方法(名称注入)，线程安全
 */</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;seckillOptimisticLockRedisSafeService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">ISeckillService</span> seckillOptimisticLockRedisSafeService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">createOptimisticLockOrderWithRedisWrong</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查库存</span>
    <span class="token class-name">StockDto</span> stockDto <span class="token operator">=</span> <span class="token class-name">SeckillOptimisticLockRedisWrongServiceImpl</span><span class="token punctuation">.</span><span class="token function">checkStock</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 扣库存</span>
    <span class="token class-name">Integer</span> saleCount <span class="token operator">=</span> <span class="token class-name">SeckillOptimisticLockRedisWrongServiceImpl</span><span class="token punctuation">.</span><span class="token function">saleStock</span><span class="token punctuation">(</span>stockDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>saleCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">&quot;扣库存失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 下订单</span>
    <span class="token class-name">Integer</span> orderCount <span class="token operator">=</span> <span class="token class-name">SeckillOptimisticLockRedisWrongServiceImpl</span><span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>stockDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>saleCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">&quot;下订单失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> orderCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">createOptimisticLockOrderWithRedisSafe</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查库存</span>
    <span class="token class-name">StockDto</span> stockDto <span class="token operator">=</span> seckillOptimisticLockRedisSafeService<span class="token punctuation">.</span><span class="token function">checkStock</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 扣库存</span>
    <span class="token class-name">Integer</span> saleCount <span class="token operator">=</span> seckillOptimisticLockRedisSafeService<span class="token punctuation">.</span><span class="token function">saleStock</span><span class="token punctuation">(</span>stockDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>saleCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">&quot;扣库存失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 下订单</span>
    <span class="token class-name">Integer</span> orderCount <span class="token operator">=</span> seckillOptimisticLockRedisSafeService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>stockDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>saleCount <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">&quot;下订单失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> orderCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-错误实现"><a href="#_3-错误实现" class="header-anchor">#</a> 3. 错误实现</h2> <p>然后创建一个<strong>ISeckillService</strong>的使用乐观锁方式的实现类(线程不安全)</p> <ul><li><strong>SeckillOptimisticLockRedisWrongServiceImpl</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 使用乐观锁加缓存
 *
 * @author wliduo[i@dolyw.com]
 * @date 2019-11-20 18:03:33
 */</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;seckillOptimisticLockRedisWrongService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillOptimisticLockRedisWrongServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ISeckillService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * logger
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SeckillOptimisticLockRedisServiceImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockDao</span> stockDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockOrderDao</span> stockOrderDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">StockDto</span> <span class="token function">checkStock</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用缓存读取库存，减轻DB压力</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_COUNT <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> sale <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_SALE <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 第一个线程和第二个线程同时读取缓存count时，都读取到10，然后第二个线程暂停了，第一个线程继续执行，</span>
        <span class="token comment">// 读取的version版本号为0，继续执行到已经秒杀完成，更新缓存(version版本号加一，变成1)，</span>
        <span class="token comment">// 现在第二个线程才恢复继续执行，结果读取缓存version版本号为1(本来应该也是0)</span>
        <span class="token class-name">Integer</span> version <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_VERSION <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 还有库存</span>
            <span class="token class-name">StockDto</span> stockDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stockDto<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stockDto<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stockDto<span class="token punctuation">.</span><span class="token function">setSale</span><span class="token punctuation">(</span>sale<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stockDto<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> stockDto<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">saleStock</span><span class="token punctuation">(</span><span class="token class-name">StockDto</span> stockDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> saleCount <span class="token operator">=</span> stockDao<span class="token punctuation">.</span><span class="token function">updateByOptimisticLock</span><span class="token punctuation">(</span>stockDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 操作数据大于0，说明扣库存成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>saleCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;版本号:{} {} {}&quot;</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getSale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新缓存，这里更新需要保证三个数据(库存，已售，乐观锁版本号)的一致性，使用Redis事务</span>
            <span class="token function">updateCache</span><span class="token punctuation">(</span>stockDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> saleCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 这里遵循先更新数据库，再更新缓存，详细的数据库与缓存一致性解析可以查看
     * https://note.dolyw.com/cache/00-DataBaseConsistency.html
     *
     * @param stockDto
     * @return java.lang.Integer
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/22 16:25
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateCache</span><span class="token punctuation">(</span><span class="token class-name">StockDto</span> stockDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取事务</span>
        <span class="token class-name">Transaction</span> transaction <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">getJedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// watch监视key，当事务执行之前这个key发生了改变，事务会被打断</span>
            jedis<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_COUNT <span class="token operator">+</span> stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_SALE <span class="token operator">+</span> stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_VERSION <span class="token operator">+</span> stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 开始事务</span>
            transaction <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 原子操作库存减一</span>
            transaction<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_COUNT <span class="token operator">+</span> stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 原子操作已售数和乐观锁版本号加一</span>
            transaction<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_SALE <span class="token operator">+</span> stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            transaction<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_VERSION <span class="token operator">+</span> stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 执行exec后就会自动执行jedis.unwatch()操作</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> result<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 事务失败了，可能是watch-key被外部修改，或者是数据操作被驳回</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;更新缓存失败: {}&quot;</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// watch-key被外部修改时，transaction.discard()操作会被自动触发</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;更新缓存失败: {}，异常原因: {}&quot;</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 关闭事务</span>
                transaction<span class="token punctuation">.</span><span class="token function">discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">StockDto</span> stockDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StockOrderDto</span> stockOrderDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockOrderDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockOrderDto<span class="token punctuation">.</span><span class="token function">setStockId</span><span class="token punctuation">(</span>stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stockOrderDao<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>stockOrderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-1-开始测试"><a href="#_3-1-开始测试" class="header-anchor">#</a> 3.1. 开始测试</h3> <p>修改<strong>SeckillEvolutionController</strong>的入口下单方法<strong>createOptimisticLockOrderWithRedis</strong>调用<strong>createOptimisticLockOrderWithRedisWrong</strong>线程不安全方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 使用乐观锁下订单，并且添加读缓存，性能提升
 *
 * @param id 商品ID
 * @return com.example.common.ResponseBean
 * @throws Exception
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/22 14:24
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/createOptimisticLockOrderWithRedis/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseBean</span> <span class="token function">createOptimisticLockOrderWithRedis</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 错误的，线程不安全</span>
    <span class="token class-name">Integer</span> orderCount <span class="token operator">=</span> seckillEvolutionService<span class="token punctuation">.</span><span class="token function">createOptimisticLockOrderWithRedisWrong</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 正确的，线程安全</span>
    <span class="token comment">// Integer orderCount = seckillEvolutionService.createOptimisticLockOrderWithRedisSafe(id);</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBean</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;购买成功&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用<strong>JMeter</strong>测试上面的代码，<strong>JMeter</strong>的使用可以查看: <a href="http://note.dolyw.com/command/06-JMeter-Install.html" target="_blank" rel="noopener noreferrer">JMeter的安装使用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>我们调用一下商品库存初始化的方法，我使用的是<strong>PostMan</strong>，初始化库存表商品<strong>10</strong>个库存，而且清空订单表</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191122001.png" alt="图片"></p> <p>接着使用<strong>PostMan</strong>调用缓存预热方法，提前加载好缓存</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191122013.png" alt="图片"></p> <p>这时候可以看到我们的数据，库存为<strong>10</strong>，卖出为<strong>0</strong>，订单表为空</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191123001.png" alt="图片"></p> <p>缓存数据也是这样</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191123006.png" alt="图片"></p> <p>打开<strong>JMeter</strong>，添加测试计划(<code>测试计划文件在项目的src\main\resources\jmx下</code>)，模拟<strong>500</strong>个并发线程测试秒杀<strong>10</strong>个库存的商品，填写请求地址，点击启动图标开始</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191123007.png" alt="图片"></p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191122016.png" alt="图片"></p> <p>可以看到<strong>500</strong>个并发线程执行完，最后发现<strong>库存出现负数</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191123008.png" alt="图片"></p> <h3 id="_3-2-结果总结"><a href="#_3-2-结果总结" class="header-anchor">#</a> 3.2. 结果总结</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 使用缓存读取库存，减轻DB压力</span>
<span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_COUNT <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Integer</span> sale <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_SALE <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Integer</span> version <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_VERSION <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>一开始没考虑好，结果发现<strong>这块读取缓存代码会存在线程不安全</strong>的情况，比如有个线程读取<strong>Resid</strong>的<strong>count</strong>库存时，正好另一个已经执行的前面的线程更新缓存事务提交了，结果导致读取到<strong>version</strong>版本号与库存不一致，不是同一个事务的数据了</p> <div class="language-java extra-class"><pre class="language-java"><code>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;版本号:{} {} {}&quot;</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getSale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">17.874</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">10</span> <span class="token number">0</span> <span class="token number">0</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">17.910</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">10</span> <span class="token number">0</span> <span class="token number">1</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">17.964</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">26</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">10</span> <span class="token number">0</span> <span class="token number">2</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.010</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">10</span> <span class="token number">1</span> <span class="token number">3</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.033</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">10</span> <span class="token number">1</span> <span class="token number">4</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.085</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">10</span> <span class="token number">2</span> <span class="token number">5</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.108</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">23</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">9</span> <span class="token number">3</span> <span class="token number">6</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.145</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">19</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">8</span> <span class="token number">5</span> <span class="token number">7</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.169</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">8</span> <span class="token number">5</span> <span class="token number">8</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.198</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">60</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">7</span> <span class="token number">5</span> <span class="token number">9</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.236</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">39</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">6</span> <span class="token number">7</span> <span class="token number">10</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.282</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">40</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">5</span> <span class="token number">8</span> <span class="token number">11</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.311</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">48</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">4</span> <span class="token number">10</span> <span class="token number">12</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.336</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">51</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">3</span> <span class="token number">10</span> <span class="token number">13</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.372</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">55</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">2</span> <span class="token number">11</span> <span class="token number">14</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">22</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">42</span><span class="token operator">:</span><span class="token number">18.396</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">52</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">1</span> <span class="token number">12</span> <span class="token number">15</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">分析</p> <p>看日志，详细分析下错误流程，例如有两个线程启动，第一个线程和第二个线程同时读取缓存<strong>count</strong>时，都读取到<strong>10</strong>，然后第二个线程暂停了，第一个线程继续执行，读取的<strong>version</strong>版本号为<strong>0</strong>，继续执行到已经秒杀完成，更新缓存(<strong>version</strong>版本号加一，变成<strong>1</strong>)，现在第二个线程才恢复继续执行，结果读取缓存<strong>version</strong>版本号为<strong>1</strong>(不是同一个事务的数据，本来应该也是<strong>0</strong>)，所以变成了<strong>10 0 1</strong>的错误数据</p></div> <h3 id="_3-3-如何解决"><a href="#_3-3-如何解决" class="header-anchor">#</a> 3.3. 如何解决</h3> <h4 id="_3-3-1-乐观锁扣库存时加上库存大于0的判断，and-count-0"><a href="#_3-3-1-乐观锁扣库存时加上库存大于0的判断，and-count-0" class="header-anchor">#</a> 3.3.1. 乐观锁扣库存时加上库存大于0的判断，AND count &gt; 0</h4> <ul><li><strong>StockDao</strong></li></ul> <div class="language-java extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-java"><code><span class="token comment">/**
 * 乐观锁更新扣减库存
 *
 * @param stockDto
 * @return int
 * @throws
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/22 14:14
 */</span>
<span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;UPDATE t_seckill_stock SET count = count - 1, sale = sale + 1, version = version + 1 &quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;WHERE id = #{id, jdbcType = INTEGER} AND version = #{version, jdbcType = INTEGER} &quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;AND count &gt; 0&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">updateByOptimisticLock</span><span class="token punctuation">(</span><span class="token class-name">StockDto</span> stockDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-3-2-给这块读取代码加上redis事务-乐观锁-或者分布式锁-悲观锁"><a href="#_3-3-2-给这块读取代码加上redis事务-乐观锁-或者分布式锁-悲观锁" class="header-anchor">#</a> 3.3.2. 给这块读取代码加上Redis事务(乐观锁)或者分布式锁(悲观锁)</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 使用缓存读取库存，减轻DB压力</span>
<span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_COUNT <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Integer</span> sale <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_SALE <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Integer</span> version <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_VERSION <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-3-3-使用redis批量操作-mget和mset"><a href="#_3-3-3-使用redis批量操作-mget和mset" class="header-anchor">#</a> 3.3.3. 使用Redis批量操作(mget和mset)</h4> <p><strong>mget</strong>和<strong>mset</strong>可以批量获取和设置<strong>Redis</strong>键值，具有原子性，这种方式更简单，就先用这个了，看下面正确实现</p> <h2 id="_4-正确实现"><a href="#_4-正确实现" class="header-anchor">#</a> 4. 正确实现</h2> <ul><li><strong>SeckillOptimisticLockRedisSafeServiceImpl</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>seckill<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>constant</span><span class="token punctuation">.</span><span class="token class-name">Constant</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>dao</span><span class="token punctuation">.</span><span class="token class-name">StockDao</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>dao</span><span class="token punctuation">.</span><span class="token class-name">StockOrderDao</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>custom</span><span class="token punctuation">.</span><span class="token class-name">StockDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>dto<span class="token punctuation">.</span>custom</span><span class="token punctuation">.</span><span class="token class-name">StockOrderDto</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>exception</span><span class="token punctuation">.</span><span class="token class-name">CustomException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>seckill</span><span class="token punctuation">.</span><span class="token class-name">ISeckillService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">JedisUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Service</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis</span><span class="token punctuation">.</span><span class="token class-name">Jedis</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">redis<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>jedis</span><span class="token punctuation">.</span><span class="token class-name">Transaction</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 使用乐观锁加缓存的方式(线程安全)(使用Redis批量操作mget和mset具有原子性)
 *
 * @author wliduo[i@dolyw.com]
 * @date 2019-11-20 18:03:33
 */</span>
<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;seckillOptimisticLockRedisSafeService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SeckillOptimisticLockRedisSafeServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ISeckillService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * logger
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SeckillOptimisticLockRedisSafeServiceImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockDao</span> stockDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockOrderDao</span> stockOrderDao<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">StockDto</span> <span class="token function">checkStock</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用缓存读取库存，减轻DB压力，Redis批量操作(具有原子性)解决线程安全问题</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataList <span class="token operator">=</span> <span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">mget</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_COUNT <span class="token operator">+</span> id<span class="token punctuation">,</span>
                <span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_SALE <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_VERSION <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> sale <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> version <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>dataList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 还有库存</span>
            <span class="token class-name">StockDto</span> stockDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stockDto<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stockDto<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stockDto<span class="token punctuation">.</span><span class="token function">setSale</span><span class="token punctuation">(</span>sale<span class="token punctuation">)</span><span class="token punctuation">;</span>
            stockDto<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> stockDto<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">&quot;库存不足&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">saleStock</span><span class="token punctuation">(</span><span class="token class-name">StockDto</span> stockDto<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> saleCount <span class="token operator">=</span> stockDao<span class="token punctuation">.</span><span class="token function">updateByOptimisticLock</span><span class="token punctuation">(</span>stockDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 操作数据大于0，说明扣库存成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>saleCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;版本号:{} {} {}&quot;</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getSale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新缓存，这里更新需要保证三个数据(库存，已售，乐观锁版本号)的一致性，使用mset原子操作</span>
            <span class="token function">updateCache</span><span class="token punctuation">(</span>stockDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> saleCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 这里遵循先更新数据库，再更新缓存，详细的数据库与缓存一致性解析可以查看
     * https://note.dolyw.com/cache/00-DataBaseConsistency.html
     *
     * @param stockDto
     * @return java.lang.Integer
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/22 16:25
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateCache</span><span class="token punctuation">(</span><span class="token class-name">StockDto</span> stockDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Integer</span> count <span class="token operator">=</span> stockDto<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> sale <span class="token operator">=</span> stockDto<span class="token punctuation">.</span><span class="token function">getSale</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> version <span class="token operator">=</span> stockDto<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">mset</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_COUNT <span class="token operator">+</span> stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_SALE <span class="token operator">+</span> stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sale<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Constant</span><span class="token punctuation">.</span>PREFIX_VERSION <span class="token operator">+</span> stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> version<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">StockDto</span> stockDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StockOrderDto</span> stockOrderDto <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockOrderDto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stockOrderDto<span class="token punctuation">.</span><span class="token function">setStockId</span><span class="token punctuation">(</span>stockDto<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> stockOrderDao<span class="token punctuation">.</span><span class="token function">insertSelective</span><span class="token punctuation">(</span>stockOrderDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-1-开始测试"><a href="#_4-1-开始测试" class="header-anchor">#</a> 4.1. 开始测试</h3> <p>修改<strong>SeckillEvolutionController</strong>的入口下单方法<strong>createOptimisticLockOrderWithRedis</strong>调用<strong>createOptimisticLockOrderWithRedisSafe</strong>线程安全方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 使用乐观锁下订单，并且添加读缓存，性能提升
 *
 * @param id 商品ID
 * @return com.example.common.ResponseBean
 * @throws Exception
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/22 14:24
 */</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/createOptimisticLockOrderWithRedis/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseBean</span> <span class="token function">createOptimisticLockOrderWithRedis</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// 错误的，线程不安全</span>
    <span class="token comment">// Integer orderCount = seckillEvolutionService.createOptimisticLockOrderWithRedisWrong(id);</span>
    <span class="token comment">// 正确的，线程安全</span>
    <span class="token class-name">Integer</span> orderCount <span class="token operator">=</span> seckillEvolutionService<span class="token punctuation">.</span><span class="token function">createOptimisticLockOrderWithRedisSafe</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ResponseBean</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;购买成功&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用<strong>JMeter</strong>测试上面的代码，<strong>JMeter</strong>的使用可以查看: <a href="http://note.dolyw.com/command/06-JMeter-Install.html" target="_blank" rel="noopener noreferrer">JMeter的安装使用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>我们调用一下商品库存初始化的方法，我使用的是<strong>PostMan</strong>，初始化库存表商品<strong>10</strong>个库存，而且清空订单表</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191122001.png" alt="图片"></p> <p>接着使用<strong>PostMan</strong>调用缓存预热方法，提前加载好缓存</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191122013.png" alt="图片"></p> <p>这时候可以看到我们的数据，库存为<strong>10</strong>，卖出为<strong>0</strong>，订单表为空</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191123001.png" alt="图片"></p> <p>缓存数据也是这样</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191123006.png" alt="图片"></p> <p>打开<strong>JMeter</strong>，添加测试计划(<code>测试计划文件在项目的src\main\resources\jmx下</code>)，模拟<strong>500</strong>个并发线程测试秒杀<strong>10</strong>个库存的商品，填写请求地址，点击启动图标开始</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191123007.png" alt="图片"></p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191122016.png" alt="图片"></p> <p>可以看到<strong>500</strong>个并发线程执行完，可以看到这次是正确的了</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191123009.png" alt="图片"></p> <p>日志也没问题了</p> <div class="language-java extra-class"><pre class="language-java"><code>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;版本号:{} {} {}&quot;</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getSale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stockDto<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">48.494</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">10</span> <span class="token number">0</span> <span class="token number">0</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">48.587</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>nio<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">9</span> <span class="token number">1</span> <span class="token number">1</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">48.691</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">8</span> <span class="token number">2</span> <span class="token number">2</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">48.734</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>o<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">134</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">7</span> <span class="token number">3</span> <span class="token number">3</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">48.778</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">6</span> <span class="token number">4</span> <span class="token number">4</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">48.826</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">75</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">5</span> <span class="token number">5</span> <span class="token number">5</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">48.874</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>io<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">4</span> <span class="token number">6</span> <span class="token number">6</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">48.927</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>o<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">113</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">3</span> <span class="token number">7</span> <span class="token number">7</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">48.974</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>o<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">180</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">2</span> <span class="token number">8</span> <span class="token number">8</span>
<span class="token number">2019</span><span class="token operator">-</span><span class="token number">11</span><span class="token operator">-</span><span class="token number">23</span> <span class="token number">13</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">49.020</span>  INFO <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>o<span class="token operator">-</span><span class="token number">8080</span><span class="token operator">-</span>exec<span class="token operator">-</span><span class="token number">199</span><span class="token punctuation">]</span> <span class="token operator">:</span> 版本号<span class="token operator">:</span><span class="token number">1</span> <span class="token number">9</span> <span class="token number">9</span>
</code></pre></div><h3 id="_4-2-结果总结"><a href="#_4-2-结果总结" class="header-anchor">#</a> 4.2. 结果总结</h3> <p>最后我们可以看下<strong>Druid</strong>的监控，地址: <a href="http://localhost:8080/druid/sql.html" target="_blank" rel="noopener noreferrer">http://localhost:8080/druid/sql.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>使用了缓存，可以看到库存查询<strong>SQL</strong>，<strong>只执行了一次，就是缓存预热那执行了一次</strong>，不像之前每次库存都去查数据库</p> <p><img src="https://cdn.jsdelivr.net/gh/wliduo/CDN@master/2019/11/20191123010.png" alt="图片"></p> <p>不过<strong>乐观锁更新</strong>操作还是执行了<strong>157</strong>次<strong>SQL</strong>，遵从<strong>最后落地到数据库的请求数要尽量少</strong>的原则，有没有办法优化这里呢，可以的，<strong>实际上很多都是无效请求</strong>，这里我们可以使用<strong>限流</strong>，把大部分无效请求拦截了，尽可能保证最终到达数据库的都是有效请求</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/dolyw/Note/edit/master/doc/seckill-evolution/03-Optimistic-Lock-Redis.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">2019-12-03 17:35:51</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/seckill-evolution/02-Optimistic-Lock.html" class="prev">2. 使用乐观锁</a></span> <span class="next"><a href="/seckill-evolution/04-Distributed-Limit.html">4. 使用分布式限流</a>
      →
    </span></p></div> </main></div><div class="global-ui"><div class="diy-loader center" style="display:none;" data-v-e3547698><div class="center-box" data-v-e3547698><div class="loader_overlay" data-v-e3547698></div> <div class="loader_cogs" data-v-e3547698><div class="loader_cogs__top" data-v-e3547698><div class="top_part" data-v-e3547698></div> <div class="top_part" data-v-e3547698></div> <div class="top_part" data-v-e3547698></div> <div class="top_hole" data-v-e3547698></div></div> <div class="loader_cogs__left" data-v-e3547698><div class="left_part" data-v-e3547698></div> <div class="left_part" data-v-e3547698></div> <div class="left_part" data-v-e3547698></div> <div class="left_hole" data-v-e3547698></div></div> <div class="loader_cogs__bottom" data-v-e3547698><div class="bottom_part" data-v-e3547698></div> <div class="bottom_part" data-v-e3547698></div> <div class="bottom_part" data-v-e3547698></div> <div class="bottom_hole" data-v-e3547698></div></div></div> <p class="loading-text" data-v-e3547698>
      页面加载中<span class="dot" data-v-e3547698>...</span></p></div></div><div class="my-popup" style="display:none;" data-v-3414bdeb><div class="my-popup-container" data-v-3414bdeb><div class="my-popup-exit" data-v-3414bdeb></div> <img src="" alt data-v-3414bdeb></div></div><!----><div></div></div></div>
    <script src="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/app.4fdd9329.js" defer></script><script src="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/2.def9963f.js" defer></script><script src="https://cdn.jsdelivr.net/gh/dolyw/Note@master/docs/assets/js/80.faf6cde6.js" defer></script>
  </body>
</html>
