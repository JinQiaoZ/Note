<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用分布式限流 | 笔记</title>
    <meta name="description" content="世界上最大的谎言就是你不行">
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/wliduo/Index@master/static/favicon.ico">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/wliduo/Index@master/static/count.js"></script>
    
    <link rel="preload" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/css/0.styles.ce1e9339.css" as="style"><link rel="preload" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/app.8145a6fe.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/2.014606d6.js" as="script"><link rel="preload" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/56.1acbd6bd.js" as="script"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/10.a48a3c47.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/11.2e55eef2.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/12.f2ef1cbb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/13.3629ef2a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/14.851bf3ba.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/15.8bc10742.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/16.ba6f39c9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/17.09b60a10.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/18.66a2235b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/19.ccda4b2f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/20.40bef4cd.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/21.5bf2883b.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/22.62c83b06.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/23.ad9f69ad.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/24.f5f3f998.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/25.f76f4ffd.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/26.57862b6a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/27.05bae053.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/28.ccea7500.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/29.8313edbb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/3.4e0ca384.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/30.5b6073a6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/31.f74f0da6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/32.0efcd2e7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/33.34e299de.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/34.7ba98d10.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/35.c1f44946.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/36.7d30ced7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/37.20c0d5be.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/38.8851d1e9.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/39.ab55bd81.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/4.4ad13904.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/40.3c020743.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/41.8d8f6c8a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/42.a687b804.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/43.ce9358ba.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/44.b9d0b87f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/45.e2974b32.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/46.2573c2d1.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/47.bc8f592e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/48.0f6d3876.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/49.d880be39.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/5.ed345d91.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/50.8f459057.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/51.fb2ee18f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/52.c938cc0a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/53.0ac4c427.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/54.96013cbf.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/55.b5babc92.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/57.f6050fe4.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/58.fd39f315.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/59.2dc9f51f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/6.048a7feb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/60.e34a5f81.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/61.575ac8e0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/62.f25188c3.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/63.69969ceb.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/64.04827c9f.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/65.5d03d39e.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/66.9402f750.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/67.f5eb2c08.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/68.f136fbe0.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/69.cc52994a.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/7.531168ce.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/70.16c51163.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/71.262dc6f7.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/72.4c471ce6.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/8.76af8b00.js"><link rel="prefetch" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/9.d2eafd88.js">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/css/0.styles.ce1e9339.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习记录" class="dropdown-title"><span class="title">学习记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/netty/" class="nav-link">Netty</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/elasticsearch/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/cache/" class="nav-link">缓存</a></li><li class="dropdown-item"><!----> <a href="/database/" class="nav-link">数据库</a></li><li class="dropdown-item"><!----> <a href="/front/" class="nav-link">前端记录</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构记录" class="dropdown-title"><span class="title">架构记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/seckill/" class="nav-link">秒杀架构</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他补充" class="dropdown-title"><span class="title">其他补充</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/command/" class="nav-link">工具命令</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">零散记录</a></li><li class="dropdown-item"><!----> <a href="/gossip/" class="nav-link">编程闲话</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/p/" class="nav-link">项目列表</a></li><li class="dropdown-item"><!----> <a href="/shirojwt/" class="nav-link">ShiroJwt</a></li><li class="dropdown-item"><!----> <a href="/seckill-evolution/" class="nav-link router-link-active">SeckillEvolution</a></li><li class="dropdown-item"><!----> <a href="/viewgenerator/" class="nav-link">ViewGenerator</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">关于投食</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="联系" class="dropdown-title"><span class="title">联系</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://map.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://blog.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://res.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  音乐
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://msg.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  留言
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://cv.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简历
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://github.com/dolyw" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习记录" class="dropdown-title"><span class="title">学习记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/netty/" class="nav-link">Netty</a></li><li class="dropdown-item"><!----> <a href="/docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/elasticsearch/" class="nav-link">Elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/cache/" class="nav-link">缓存</a></li><li class="dropdown-item"><!----> <a href="/database/" class="nav-link">数据库</a></li><li class="dropdown-item"><!----> <a href="/front/" class="nav-link">前端记录</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="架构记录" class="dropdown-title"><span class="title">架构记录</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/seckill/" class="nav-link">秒杀架构</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他补充" class="dropdown-title"><span class="title">其他补充</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/command/" class="nav-link">工具命令</a></li><li class="dropdown-item"><!----> <a href="/other/" class="nav-link">零散记录</a></li><li class="dropdown-item"><!----> <a href="/gossip/" class="nav-link">编程闲话</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源项目" class="dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/p/" class="nav-link">项目列表</a></li><li class="dropdown-item"><!----> <a href="/shirojwt/" class="nav-link">ShiroJwt</a></li><li class="dropdown-item"><!----> <a href="/seckill-evolution/" class="nav-link router-link-active">SeckillEvolution</a></li><li class="dropdown-item"><!----> <a href="/viewgenerator/" class="nav-link">ViewGenerator</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">关于投食</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="联系" class="dropdown-title"><span class="title">联系</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://map.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  导航
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://blog.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://res.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  音乐
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://msg.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  留言
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://cv.dolyw.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简历
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://dolyw.com/go?url=https://github.com/dolyw" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/seckill-evolution/" class="sidebar-link">SeckillEvolution</a></li><li><a href="/seckill-evolution/00-Preparation.html" class="sidebar-link">0. 整体流程</a></li><li><a href="/seckill-evolution/01-Tradition-Process.html" class="sidebar-link">1. 传统方式</a></li><li><a href="/seckill-evolution/02-Optimistic-Lock.html" class="sidebar-link">2. 使用乐观锁</a></li><li><a href="/seckill-evolution/03-Optimistic-Lock-Redis.html" class="sidebar-link">3. 使用缓存</a></li><li><a href="/seckill-evolution/04-Distributed-Limit.html" class="active sidebar-link">4. 使用分布式限流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/seckill-evolution/04-Distributed-Limit.html#_1-思路介绍" class="sidebar-link">1. 思路介绍</a></li><li class="sidebar-sub-header"><a href="/seckill-evolution/04-Distributed-Limit.html#_2-代码实现" class="sidebar-link">2. 代码实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/seckill-evolution/04-Distributed-Limit.html#_2-1-测试controller" class="sidebar-link">2.1. 测试Controller</a></li><li class="sidebar-sub-header"><a href="/seckill-evolution/04-Distributed-Limit.html#_2-1-工具类" class="sidebar-link">2.1. 工具类</a></li><li class="sidebar-sub-header"><a href="/seckill-evolution/04-Distributed-Limit.html#_2-3-注解" class="sidebar-link">2.3. 注解</a></li></ul></li></ul></li><li><a href="/seckill-evolution/05-MQ-Async.html" class="sidebar-link">5. 使用队列异步下单</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用分布式限流"><a href="#使用分布式限流" class="header-anchor">#</a> 使用分布式限流</h1> <blockquote><p>目录: <a href="https://note.dolyw.com/seckill-evolution" target="_blank" rel="noopener noreferrer">https://note.dolyw.com/seckill-evolution<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p><strong>项目地址</strong></p> <ul><li>Github：<a href="https://github.com/dolyw/SeckillEvolution" target="_blank" rel="noopener noreferrer">https://github.com/dolyw/SeckillEvolution<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Gitee(码云)：<a href="https://gitee.com/dolyw/SeckillEvolution" target="_blank" rel="noopener noreferrer">https://gitee.com/dolyw/SeckillEvolution<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="_1-思路介绍"><a href="#_1-思路介绍" class="header-anchor">#</a> 1. 思路介绍</h2> <p>这次我们引入<strong>限流</strong>，这里可以先查看一篇文章: <a href="http://note.dolyw.com/seckill/02-Distributed-Limit.html" target="_blank" rel="noopener noreferrer">高并发下的限流分析<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>之前说到<strong>乐观锁更新</strong>操作还是执行了近<strong>100</strong>次<strong>SQL</strong>，为了遵从<strong>最后落地到数据库的请求数要尽量少</strong>的原则，这里我们使用<strong>限流</strong>，把大部分无效请求拦截，尽可能保证最终到达数据库的都是有效请求</p> <p>这里我们提供两个限流方式，都实现下</p> <ul><li>基于工具类方法限流</li> <li>基于注解形式的限流</li></ul> <h2 id="_2-代码实现"><a href="#_2-代码实现" class="header-anchor">#</a> 2. 代码实现</h2> <h3 id="_2-1-测试controller"><a href="#_2-1-测试controller" class="header-anchor">#</a> 2.1. 测试Controller</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>limit</span><span class="token punctuation">.</span><span class="token class-name">Limit</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">RedisLimitUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic</span><span class="token punctuation">.</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic</span><span class="token punctuation">.</span><span class="token class-name">AtomicLong</span><span class="token punctuation">;</span>

<span class="token comment">/**
 *  计数器(固定时间窗口)限流接口测试
 *
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/24 19:27
 */</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/limit&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LimitController</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * logger
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LimitController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 一个时间窗口内最大请求数(限流最大请求数)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> MAX_NUM_REQUEST <span class="token operator">=</span> <span class="token number">2L</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 一个时间窗口时间(毫秒)(限流时间)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> TIME_REQUEST <span class="token operator">=</span> <span class="token number">1000L</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 一个时间窗口内请求的数量累计(限流请求数累计)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> requestNum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 一个时间窗口开始时间(限流开始时间)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicLong</span> requestTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * RedisLimitUtil
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisLimitUtil</span> redisLimitUtil<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 脚本位置
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> PATH <span class="token operator">=</span> <span class="token string">&quot;redis/limit-seckill.lua&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 计数器(固定时间窗口)请求接口
     *
     * @param
     * @return java.lang.String
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/25 16:19
     */</span>
    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> nowTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断是在当前时间窗口(限流开始时间)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nowTime <span class="token operator">&lt;</span> requestTime<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> TIME_REQUEST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 判断当前时间窗口请求内是否限流最大请求数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestNum<span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAX_NUM_REQUEST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 在时间窗口内且请求数量还没超过最大，请求数加一</span>
                requestNum<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;请求成功，当前请求是{}次&quot;</span><span class="token punctuation">,</span> requestNum<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">&quot;请求成功，当前请求是&quot;</span> <span class="token operator">+</span> requestNum<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;次&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 超时后重置(开启一个新的时间窗口)</span>
            requestTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span>nowTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            requestNum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;请求失败，被限流，当前请求是{}次&quot;</span><span class="token punctuation">,</span> requestNum<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;请求失败，被限流，当前请求是&quot;</span> <span class="token operator">+</span> requestNum<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;次&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 计数器(固定时间窗口)请求接口(Redis工具类实现，秒级限流)
     *
     * @param
     * @return java.lang.String
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/25 18:02
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/redis&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> maxRequest <span class="token operator">=</span> redisLimitUtil<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>PATH<span class="token punctuation">,</span> MAX_NUM_REQUEST<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 结果请求数大于0说明不被限流</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxRequest <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;请求成功，当前请求是{}次&quot;</span><span class="token punctuation">,</span> maxRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">&quot;请求成功，当前请求是&quot;</span> <span class="token operator">+</span> maxRequest <span class="token operator">+</span> <span class="token string">&quot;次&quot;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;请求失败，被限流&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;请求拥挤，请稍候重试&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 计数器(固定时间窗口)请求接口(Redis自定义注解实现，自定义限流)
     *
     * @param
     * @return java.lang.String
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/26 9:46
     */</span>
    <span class="token annotation punctuation">@Limit</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;redis/limit-custom.lua&quot;</span><span class="token punctuation">,</span> maxRequest <span class="token operator">=</span> <span class="token string">&quot;5&quot;</span><span class="token punctuation">,</span> timeRequest <span class="token operator">=</span> <span class="token string">&quot;5000&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/annotation&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">annotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;请求成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;请求成功&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-1-工具类"><a href="#_2-1-工具类" class="header-anchor">#</a> 2.1. 工具类</h3> <ul><li>RedisLimitUtil</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>exception</span><span class="token punctuation">.</span><span class="token class-name">CustomException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">BufferedReader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">InputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io</span><span class="token punctuation">.</span><span class="token class-name">InputStreamReader</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">ArrayList</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Collections</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * RedisLimitUtil
 *
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/14 16:44
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisLimitUtil</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * logger
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">RedisLimitUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * redis-key-前缀-limit-限流
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LIMIT <span class="token operator">=</span> <span class="token string">&quot;limit:&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * redis-key-名称-limit-一个时间窗口内请求的数量累计(限流累计请求数)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LIMIT_REQUEST <span class="token operator">=</span> <span class="token string">&quot;limit:request&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * redis-key-名称-limit-一个时间窗口开始时间(限流开始时间)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> LIMIT_TIME <span class="token operator">=</span> <span class="token string">&quot;limit:time&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 秒级限流判断
     *
     * @param path Lua脚本位置
	 * @param maxRequest 限流最大请求数
     * @return boolean
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/25 17:57
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">limit</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">String</span> maxRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取key名，当前时间戳</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> LIMIT <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 传入参数，限流最大请求数</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>maxRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">eval</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 自定义参数限流判断(注解)
     *
     * @param path Lua脚本位置
     * @param maxRequest 限流最大请求数
     * @param timeRequest 一个时间窗口(秒)
     * @return boolean
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/25 17:57
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">limit</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">String</span> maxRequest<span class="token punctuation">,</span> <span class="token class-name">String</span> timeRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取key名，一个时间窗口开始时间(限流开始时间)和一个时间窗口内请求的数量累计(限流累计请求数)</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        keys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>LIMIT_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        keys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>LIMIT_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 传入参数，限流最大请求数，当前时间戳，一个时间窗口时间(毫秒)(限流时间)</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>maxRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>timeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">eval</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 执行Lua脚本方法
     *
     * @param path
	 * @param keys
	 * @param args
     * @return java.lang.Object
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/26 10:50
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取Lua脚本</span>
        <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token function">getScript</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行脚本</span>
        <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token class-name">JedisUtil</span><span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 结果请求数大于0说明不被限流</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">)</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取Lua脚本
     *
     * @param path
     * @return java.lang.String
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/25 17:57
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getScript</span><span class="token punctuation">(</span><span class="token class-name">String</span> path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuilder</span> stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token class-name">RedisLimitUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">BufferedReader</span> bufferedReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> str<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>str <span class="token operator">=</span> bufferedReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">lineSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">&quot;获取Lua限流脚本出现问题: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-3-注解"><a href="#_2-3-注解" class="header-anchor">#</a> 2.3. 注解</h3> <ul><li>pom.xml(注解借助AOP实现)</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- AOP --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-aop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>Limit</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>limit</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token comment">/**
 * 限流注解
 *
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/26 9:59
 */</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Limit</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * Lua脚本位置
     * @return
     */</span>
    <span class="token class-name">String</span> <span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;redis/limit-custom.lua&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 限流最大请求数
     * @return
     */</span>
    <span class="token class-name">String</span> <span class="token function">maxRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 一个时间窗口(毫秒)
     * @return
     */</span>
    <span class="token class-name">String</span> <span class="token function">timeRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;3000&quot;</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>LimitAspect</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>limit</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson</span><span class="token punctuation">.</span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>common</span><span class="token punctuation">.</span><span class="token class-name">ResponseBean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>exception</span><span class="token punctuation">.</span><span class="token class-name">CustomException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">RedisLimitUtil</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang</span><span class="token punctuation">.</span><span class="token class-name">ProceedingJoinPoint</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Order</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * LimitAspect限流切面
 *
 * @author wliduo[i@dolyw.com]
 * @date 2019/11/26 10:07
 */</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LimitAspect</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * logger
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LimitAspect</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * RedisLimitUtil
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisLimitUtil</span> redisLimitUtil<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 对应注解
     *
     * @param
     * @return void
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/26 10:11
     */</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(com.example.limit.Limit)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">aspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment">/**
     * 切面
     *
     * @param proceedingJoinPoint
     * @return java.lang.Object
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/26 10:11
     */</span>
    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;aspect() &amp;&amp; @annotation(limit)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token class-name">Interceptor</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> proceedingJoinPoint<span class="token punctuation">,</span> <span class="token class-name">Limit</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 返回请求数量大于0说明不被限流</span>
            <span class="token class-name">Long</span> maxRequest <span class="token operator">=</span> redisLimitUtil<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>limit<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> limit<span class="token punctuation">.</span><span class="token function">maxRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> limit<span class="token punctuation">.</span><span class="token function">timeRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>maxRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxRequest <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 放行，执行后续方法</span>
                result <span class="token operator">=</span> proceedingJoinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 直接返回响应结果</span>
                <span class="token keyword">return</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ResponseBean</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;请求拥挤，请稍候重试&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomException</span><span class="token punctuation">(</span><span class="token string">&quot;限流切面执行出现问题: &quot;</span> <span class="token operator">+</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 执行方法前再执行
     *
     * @param limit
     * @return void
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/26 10:10
     */</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;aspect() &amp;&amp; @annotation(limit)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">Limit</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// logger.info(&quot;before&quot;);</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 执行方法后再执行
     *
     * @param limit
     * @return void
     * @throws
     * @author wliduo[i@dolyw.com]
     * @date 2019/11/26 10:10
     */</span>
    <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">&quot;aspect() &amp;&amp; @annotation(limit)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token class-name">Limit</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// logger.info(&quot;after&quot;);</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>待补充</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/dolyw/Note/edit/master/doc/seckill-evolution/04-Distributed-Limit.md" target="_blank" rel="noopener noreferrer">在GitHub上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">2019-11-23 16:12:43</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/seckill-evolution/03-Optimistic-Lock-Redis.html" class="prev">3. 使用缓存</a></span> <span class="next"><a href="/seckill-evolution/05-MQ-Async.html">5. 使用队列异步下单</a>
      →
    </span></p></div> </main></div><div class="global-ui"><div class="diy-loader center" style="display:none;" data-v-65063b36><div class="center-box" data-v-65063b36><div class="loader_overlay" data-v-65063b36></div> <div class="loader_cogs" data-v-65063b36><div class="loader_cogs__top" data-v-65063b36><div class="top_part" data-v-65063b36></div> <div class="top_part" data-v-65063b36></div> <div class="top_part" data-v-65063b36></div> <div class="top_hole" data-v-65063b36></div></div> <div class="loader_cogs__left" data-v-65063b36><div class="left_part" data-v-65063b36></div> <div class="left_part" data-v-65063b36></div> <div class="left_part" data-v-65063b36></div> <div class="left_hole" data-v-65063b36></div></div> <div class="loader_cogs__bottom" data-v-65063b36><div class="bottom_part" data-v-65063b36></div> <div class="bottom_part" data-v-65063b36></div> <div class="bottom_part" data-v-65063b36></div> <div class="bottom_hole" data-v-65063b36></div></div></div> <p class="loading-text" data-v-65063b36>
      页面加载中<span class="dot" data-v-65063b36>...</span></p></div></div><div class="my-popup" style="display:none;" data-v-3414bdeb><div class="my-popup-container" data-v-3414bdeb><div class="my-popup-exit" data-v-3414bdeb></div> <img src="" alt data-v-3414bdeb></div></div><!----><div></div></div></div>
    <script src="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/app.8145a6fe.js" defer></script><script src="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/2.014606d6.js" defer></script><script src="https://cdn.jsdelivr.net/gh/wliduo/Note@master/docs/assets/js/56.1acbd6bd.js" defer></script>
  </body>
</html>
